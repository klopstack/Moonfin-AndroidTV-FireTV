name: Build APK

on:
  push:
    branches: [ master, develop ]
  pull_request:
    branches: [ master, develop ]
  workflow_dispatch:
    inputs:
      release_build:
        description: 'Build signed release APK'
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Extract version from gradle.properties
      id: version
      run: |
        VERSION=$(grep '^flickpickle.version=' gradle.properties | cut -d'=' -f2 | sed 's/^v//')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Cache Gradle packages
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
        restore-keys: |
          ${{ runner.os }}-gradle-

    - name: Setup debug keystore
      env:
        DEBUG_KEYSTORE_BASE64: ${{ secrets.DEBUG_KEYSTORE_BASE64 }}
      run: |
        mkdir -p ~/.android
        if [ ! -z "$DEBUG_KEYSTORE_BASE64" ]; then
          echo "$DEBUG_KEYSTORE_BASE64" | base64 -d > ~/.android/debug.keystore
          echo "Debug keystore configured from secrets"
        else
          echo "Debug keystore not configured, Android will generate one"
        fi

    - name: Decode and setup release keystore
      if: github.event.inputs.release_build == 'true' || github.ref == 'refs/heads/master'
      env:
        KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
        KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        if [ ! -z "$KEYSTORE_BASE64" ]; then
          echo "$KEYSTORE_BASE64" | base64 -d > app/release-keystore.jks
          echo "storeFile=release-keystore.jks" > keystore.properties
          echo "storePassword=$KEYSTORE_PASSWORD" >> keystore.properties
          echo "keyAlias=$KEY_ALIAS" >> keystore.properties
          echo "keyPassword=$KEY_PASSWORD" >> keystore.properties
        else
          echo "Keystore secrets not configured, will build unsigned"
        fi

    - name: Run tests
      run: ./gradlew test --stacktrace

    - name: Run Detekt
      run: ./gradlew detekt --stacktrace
      continue-on-error: true

    - name: Build Debug APK
      if: github.event.inputs.release_build != 'true'
      run: ./gradlew assembleDebug --stacktrace

    - name: Build Release APK
      if: github.event.inputs.release_build == 'true' || github.ref == 'refs/heads/master'
      run: ./gradlew assembleRelease --stacktrace

    - name: Upload Debug APK
      if: github.event.inputs.release_build != 'true'
      uses: actions/upload-artifact@v4
      with:
        name: moonfin-androidtv-debug
        path: app/build/outputs/apk/debug/*.apk
        retention-days: 14

    - name: Upload Release APK
      if: github.event.inputs.release_build == 'true' || github.ref == 'refs/heads/master'
      uses: actions/upload-artifact@v4
      with:
        name: moonfin-androidtv-release
        path: app/build/outputs/apk/release/*.apk
        retention-days: 90

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          **/build/reports/tests/
          **/build/test-results/
        retention-days: 7

    - name: Upload Detekt results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: detekt-results
        path: build/reports/detekt/
        retention-days: 7

    - name: Create GitHub Release
      if: github.ref == 'refs/heads/master' && (github.event.inputs.release_build == 'true' || github.event_name == 'push')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.version }}
        name: FlickPickle v${{ steps.version.outputs.version }}
        body: |
          ## FlickPickle for Android TV v${{ steps.version.outputs.version }}

          Automated release build from master branch.

          ### Installation
          Download the APK below and sideload it onto your Android TV device.

          ### Changes
          See the [commit history](https://github.com/${{ github.repository }}/commits/master) for details.
        files: |
          app/build/outputs/apk/release/*.apk
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, '-rc') || contains(steps.version.outputs.version, '-beta') || contains(steps.version.outputs.version, '-alpha') }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
