name: Version Check

on:
  pull_request:
    branches: [ master, develop ]

jobs:
  check-version:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout PR branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.head.sha }}

    - name: Get PR version
      id: pr_version
      run: |
        VERSION=$(grep '^moonfin.version=' gradle.properties | cut -d'=' -f2 | sed 's/^v//')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "PR Version: $VERSION"

    - name: Checkout base branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.base.ref }}

    - name: Get base version
      id: base_version
      run: |
        VERSION=$(grep '^moonfin.version=' gradle.properties | cut -d'=' -f2 | sed 's/^v//')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Base Version: $VERSION"

    - name: Compare versions
      run: |
        PR_VERSION="${{ steps.pr_version.outputs.version }}"
        BASE_VERSION="${{ steps.base_version.outputs.version }}"

        echo "Base version: $BASE_VERSION"
        echo "PR version: $PR_VERSION"

        if [ "$PR_VERSION" = "$BASE_VERSION" ]; then
          echo "❌ ERROR: Version was not bumped!"
          echo ""
          echo "The version in gradle.properties must be incremented for PRs."
          echo "Current version: $BASE_VERSION"
          echo ""
          echo "Please update moonfin.version in gradle.properties to a new version:"
          echo "  - Patch bump (bug fixes): ${BASE_VERSION%.*}.$((${BASE_VERSION##*.}+1))"
          echo "  - Minor bump (new features): ${BASE_VERSION%.*.*}.$((${BASE_VERSION#*.*.}+1)).0"
          echo "  - Pre-release: $BASE_VERSION-rc.1"
          exit 1
        fi

        echo "✅ Version bumped from $BASE_VERSION to $PR_VERSION"
